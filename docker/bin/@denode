#!/usr/bin/env zsh
set -e

#
#
#

source "$DOTFILES/functions/help.sh"

DESCRIPTION="Opens a node docker container to run a node app."

USAGE=$(cat <<EOF
USAGE:
  @denode [image] [dir]

OPTIONS:
  -h, --help            Show this help message
  --description         Show descriptive summary

  <image>               The node image to run inside (defaults to latest or .nvmrc if available)
  <dir>                 The directory to load inside of the docker image

EXAMPLE:
  @denode node:20 .

EOF
)


applyHelp "$DESCRIPTION" "$USAGE" "all arguments optional" "$@"

#
#
#

image="node:latest"
dir="."


# Check for Image Tag
# E.G.: denode node:20
if [[ $1 == node:* ]]; then
    image=$1
    shift
fi

# Check for Directory
# E.G.: denode ./example_node_dir
if [[ -d $1 ]]; then
    dir=$1
    shift
fi

# Resolve absolute path
abs_dir=$(cd "$dir" && pwd)

# NVMRC Auto-Detection
# If the user didn't specify a version and an .nvmrc exists...
if [[ "$image" == "node:latest" && -f "$abs_dir/.nvmrc" ]]; then
    nvm_version=$(cat "$abs_dir/.nvmrc" | tr -d '[:space:]' | sed 's/^v//')
    image="node:$nvm_version"
    echo "ðŸ“‚ Found .nvmrc, using $image"
fi

docker run -it --rm -v "$abs_dir":/app -w /app --entrypoint /bin/bash "$@" "$image"
