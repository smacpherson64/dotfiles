#!/usr/bin/env zsh
set -e

#
#
#

source "$DOTFILES/functions/help.sh"

DESCRIPTION="Opens a node docker container to run a node app."

USAGE=$(cat <<EOF
Usage: @denode [image] [dir]

Options:
  -h, --help            Show this help message
  --description         Show descriptive summary

  <image>               The node image to run inside (defaults to latest or .nvmrc if available)
  <dir>                 The directory to load inside of the docker image

Example:
  @denode node:20 .

EOF
)


applyHelp "$DESCRIPTION" "$USAGE" "all arguments optional" "$@"

#
#
#

image="node:latest"
dir="."

# 1. Check for Image Tag (e.g., node:20)
if [[ $1 == node:* ]]; then
    image=$1
    shift
fi

# 2. Check for Directory
if [[ -d $1 ]]; then
    dir=$1
    shift
fi

# 3. Resolve absolute path
abs_dir=$(cd "$dir" && pwd)

# 4. NVMRC Auto-Detection
# If the user didn't specify a version and an .nvmrc exists...
if [[ "$image" == "node:latest" && -f "$abs_dir/.nvmrc" ]]; then
    nvm_version=$(cat "$abs_dir/.nvmrc" | tr -d '[:space:]' | sed 's/^v//')
    image="node:$nvm_version"
    echo "ðŸ“‚ Found .nvmrc, using $image"
fi

echo "ðŸš€ Launching $image in $abs_dir"

# 5. Run Docker
docker run -it --rm \
    -v "$abs_dir":/app \
    -w /app \
    "$@" \
    "$image" /bin/bash
