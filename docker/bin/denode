#!/bin/bash
set -e
task='/bin/bash'
image="node:latest"
dir="."

# Check for run task
# E.G.: denode run `yarn test`
if [[ $1 == run ]]; then
    shift
    task=$1
    shift
fi

# Check for Image Tag
# E.G.: denode node:20
if [[ $1 == node:* ]]; then
    image=$1
    shift
fi

# Check for Directory
# E.G.: denode ./example_node_dir
if [[ -d $1 ]]; then
    dir=$1
    shift
fi

# Resolve absolute path
abs_dir=$(cd "$dir" && pwd)

# NVMRC Auto-Detection
# If the user didn't specify a version and an .nvmrc exists...
if [[ "$image" == "node:latest" && -f "$abs_dir/.nvmrc" ]]; then
    nvm_version=$(cat "$abs_dir/.nvmrc" | tr -d '[:space:]' | sed 's/^v//')
    image="node:$nvm_version"
    echo "ðŸ“‚ Found .nvmrc, using $image"
fi

if [[ "$task" == "/bin/bash" ]]; then
    docker run -it --rm -v "$abs_dir":/app -w /app --entrypoint /bin/bash "$@" "$image"
else
    docker run -it --rm -v "$abs_dir":/app -w /app "$@" "$image" sh -c "$task"
fi
